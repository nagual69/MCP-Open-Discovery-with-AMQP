---
id: 70ab8892-f07a-436f-b361-8c105dd95852
---
flowchart TB
    %% ===== Server & Transports =====
    subgraph ServerCore["🧩 MCP Server Core"]
        direction TB
        MCPServer[("🧠 Singleton<br/>McpServer")]
        TransportMgr[("🧭 Transport<br/>Manager")]    
    end

    subgraph Transports["🚚 Transports"]
        direction LR
        Stdio[("🖨️ stdio")] 
        HTTP[("🌐 HTTP<br/>/mcp, /health")]
        OAuth[("🔒 OAuth<br/>Middleware")] 
        AMQP[("📦 AMQP<br/>RabbitMQ")]
        AMQPEx[("📮 Exchange:<br/>AMQP_EXCHANGE")] 
        AMQPRoute[("🛣️ Routing Exch:<br/>AMQP_EXCHANGE.mcp.routing")]
    ReqQ[("📥 ${AMQP_QUEUE_PREFIX}.requests.${sessionId}")]
    ResQ[("📤 ${AMQP_QUEUE_PREFIX}.responses.${sessionId}")]
    end

    %% ===== Registry =====
    subgraph DynamicCore["🔥 Dynamic Registry Core"]
        direction TB
        CoreRegistry[("📚 CoreRegistry")] 
        HotReload[("🔄 HotReload<br/>Manager")] 
        Validator[("✅ ToolValidation<br/>Manager")] 
        TypesAdapter[("🔧 mcp‑types<br/>Adapter")] 
    end

    %% ===== Persistence & Security =====
    subgraph Persistence["🗄️ Persistence Layer"]
        direction TB
        SQLite[("💾 SQLite<br/>dynamic_registry.db")] 
        CMDB[("🧠 CMDB / Memory<br/>SQLite-backed")] 
        ToolStats[("📈 Tool<br/>Statistics")] 
    end

    subgraph Security["🔐 Security & Access"]
        direction TB
        CredManager[("🔐 Credentials<br/>Manager")] 
        Encryption[("🛡️ AES‑256<br/>Encryption")] 
        AuditTrails[("📝 Audit<br/>Trails")] 
    end

    %% ===== Prompts & Resources =====
    subgraph UXAssets["🧩 Prompts & Resources"]
        direction TB
        Prompts[("� Prompts")] 
        Resources[("� Resources")] 
    end

    %% ===== Tool Modules =====
    subgraph ToolModules["🛠️ Tool Modules"]
        direction LR
        RegTools[("🧩 Registry Tools")] 
        MemoryTools[("🧠 Memory CMDB")] 
        NetworkTools[("🌐 Network")] 
        ProxmoxTools[("🏗️ Proxmox")] 
        SNMPTools[("📡 SNMP")] 
        ZabbixTools[("🖥️ Zabbix")] 
        NMAPTools[("🔍 NMAP")] 
        CredTools[("🔐 Credentials")] 
    end

    %% ===== Observability =====
    subgraph Observability["📊 Health & Events"]
        direction TB
        Health[("✅ /health Endpoint")] 
        Heartbeat[("💓 mcp.heartbeat<br/>(fanout)")] 
    end

    %% Server wiring
    MCPServer -->|registers| CoreRegistry
    MCPServer -->|registers| Prompts
    MCPServer -->|registers| Resources
    TransportMgr --> Stdio
    TransportMgr --> HTTP
    TransportMgr --> AMQP
    HTTP --> OAuth
    HTTP --> Health

    %% Registry wiring
    CoreRegistry --> TypesAdapter
    CoreRegistry --> HotReload
    CoreRegistry --> Validator
    CoreRegistry -->|loads| RegTools
    CoreRegistry -->|loads| MemoryTools
    CoreRegistry -->|loads| NetworkTools
    CoreRegistry -->|loads| ProxmoxTools
    CoreRegistry -->|loads| SNMPTools
    CoreRegistry -->|loads| ZabbixTools
    CoreRegistry -->|loads| NMAPTools
    CoreRegistry -->|loads| CredTools
    HotReload -.->|watches| RegTools
    HotReload -.-> MemoryTools
    HotReload -.-> NetworkTools
    HotReload -.-> ProxmoxTools
    HotReload -.-> SNMPTools
    HotReload -.-> ZabbixTools
    HotReload -.-> NMAPTools
    HotReload -.-> CredTools

    %% Persistence & Security wiring
    MemoryTools -.-> CMDB
    CMDB -.-> SQLite
    CredTools -.-> CredManager
    CredManager -.->|encrypts| Encryption
    CredManager -.->|audits| AuditTrails
    CoreRegistry -.->|stats| ToolStats
    SQLite -.-> ToolStats

    %% AMQP routing details
    AMQP --- AMQPEx
    AMQPEx --> AMQPRoute
    AMQPRoute --> ReqQ
    AMQPRoute --> ResQ
    AMQPRoute -.->|mcp.request.<cat>.<method>| AMQP
    AMQPRoute -.->|discovery.<category>| AMQP
    Heartbeat -.-> AMQP

    %% Styling
    classDef core fill:#0ea5e9,stroke:#0284c7,stroke-width:2px,color:#fff
    classDef transport fill:#10b981,stroke:#059669,stroke-width:2px,color:#fff
    classDef registry fill:#a78bfa,stroke:#7c3aed,stroke-width:2px,color:#fff
    classDef storage fill:#f59e0b,stroke:#d97706,stroke-width:2px,color:#2d3436
    classDef secure fill:#ef4444,stroke:#b91c1c,stroke-width:2px,color:#fff
    classDef ux fill:#94a3b8,stroke:#64748b,stroke-width:2px,color:#fff
    classDef obs fill:#22d3ee,stroke:#0891b2,stroke-width:2px,color:#1f2937

    class MCPServer,TransportMgr core
    class Stdio,HTTP,AMQP,AMQPEx,AMQPRoute,ReqQ,ResQ transport
    class CoreRegistry,HotReload,Validator,TypesAdapter registry
    class SQLite,CMDB,ToolStats storage
    class CredManager,Encryption,AuditTrails,OAuth secure
    class Prompts,Resources ux
    class Health,Heartbeat obs