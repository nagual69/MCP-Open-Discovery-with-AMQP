---
id: 70ab8892-f07a-436f-b361-8c105dd95852
---
flowchart TB
    %% ===== Server & Transports =====
    subgraph ServerCore["ğŸ§© MCP Server Core"]
        direction TB
        MCPServer[("ğŸ§  Singleton<br/>McpServer")]
        TransportMgr[("ğŸ§­ Transport<br/>Manager")]    
    end

    subgraph Transports["ğŸšš Transports"]
        direction LR
        Stdio[("ğŸ–¨ï¸ stdio")] 
        HTTP[("ğŸŒ HTTP<br/>/mcp, /health")]
        OAuth[("ğŸ”’ OAuth<br/>Middleware")] 
        AMQP[("ğŸ“¦ AMQP<br/>RabbitMQ")]
        AMQPEx[("ğŸ“® Exchange:<br/>AMQP_EXCHANGE")] 
        AMQPRoute[("ğŸ›£ï¸ Routing Exch:<br/>AMQP_EXCHANGE.mcp.routing")]
    ReqQ[("ğŸ“¥ ${AMQP_QUEUE_PREFIX}.requests.${sessionId}")]
    ResQ[("ğŸ“¤ ${AMQP_QUEUE_PREFIX}.responses.${sessionId}")]
    end

    %% ===== Registry =====
    subgraph DynamicCore["ğŸ”¥ Dynamic Registry Core"]
        direction TB
        CoreRegistry[("ğŸ“š CoreRegistry")] 
        HotReload[("ğŸ”„ HotReload<br/>Manager")] 
        Validator[("âœ… ToolValidation<br/>Manager")] 
        TypesAdapter[("ğŸ”§ mcpâ€‘types<br/>Adapter")] 
    end

    %% ===== Persistence & Security =====
    subgraph Persistence["ğŸ—„ï¸ Persistence Layer"]
        direction TB
        SQLite[("ğŸ’¾ SQLite<br/>dynamic_registry.db")] 
        CMDB[("ğŸ§  CMDB / Memory<br/>SQLite-backed")] 
        ToolStats[("ğŸ“ˆ Tool<br/>Statistics")] 
    end

    subgraph Security["ğŸ” Security & Access"]
        direction TB
        CredManager[("ğŸ” Credentials<br/>Manager")] 
        Encryption[("ğŸ›¡ï¸ AESâ€‘256<br/>Encryption")] 
        AuditTrails[("ğŸ“ Audit<br/>Trails")] 
    end

    %% ===== Prompts & Resources =====
    subgraph UXAssets["ğŸ§© Prompts & Resources"]
        direction TB
        Prompts[("ï¿½ Prompts")] 
        Resources[("ï¿½ Resources")] 
    end

    %% ===== Tool Modules =====
    subgraph ToolModules["ğŸ› ï¸ Tool Modules"]
        direction LR
        RegTools[("ğŸ§© Registry Tools")] 
        MemoryTools[("ğŸ§  Memory CMDB")] 
        NetworkTools[("ğŸŒ Network")] 
        ProxmoxTools[("ğŸ—ï¸ Proxmox")] 
        SNMPTools[("ğŸ“¡ SNMP")] 
        ZabbixTools[("ğŸ–¥ï¸ Zabbix")] 
        NMAPTools[("ğŸ” NMAP")] 
        CredTools[("ğŸ” Credentials")] 
    end

    %% ===== Observability =====
    subgraph Observability["ğŸ“Š Health & Events"]
        direction TB
        Health[("âœ… /health Endpoint")] 
        Heartbeat[("ğŸ’“ mcp.heartbeat<br/>(fanout)")] 
    end

    %% Server wiring
    MCPServer -->|registers| CoreRegistry
    MCPServer -->|registers| Prompts
    MCPServer -->|registers| Resources
    TransportMgr --> Stdio
    TransportMgr --> HTTP
    TransportMgr --> AMQP
    HTTP --> OAuth
    HTTP --> Health

    %% Registry wiring
    CoreRegistry --> TypesAdapter
    CoreRegistry --> HotReload
    CoreRegistry --> Validator
    CoreRegistry -->|loads| RegTools
    CoreRegistry -->|loads| MemoryTools
    CoreRegistry -->|loads| NetworkTools
    CoreRegistry -->|loads| ProxmoxTools
    CoreRegistry -->|loads| SNMPTools
    CoreRegistry -->|loads| ZabbixTools
    CoreRegistry -->|loads| NMAPTools
    CoreRegistry -->|loads| CredTools
    HotReload -.->|watches| RegTools
    HotReload -.-> MemoryTools
    HotReload -.-> NetworkTools
    HotReload -.-> ProxmoxTools
    HotReload -.-> SNMPTools
    HotReload -.-> ZabbixTools
    HotReload -.-> NMAPTools
    HotReload -.-> CredTools

    %% Persistence & Security wiring
    MemoryTools -.-> CMDB
    CMDB -.-> SQLite
    CredTools -.-> CredManager
    CredManager -.->|encrypts| Encryption
    CredManager -.->|audits| AuditTrails
    CoreRegistry -.->|stats| ToolStats
    SQLite -.-> ToolStats

    %% AMQP routing details
    AMQP --- AMQPEx
    AMQPEx --> AMQPRoute
    AMQPRoute --> ReqQ
    AMQPRoute --> ResQ
    AMQPRoute -.->|mcp.request.<cat>.<method>| AMQP
    AMQPRoute -.->|discovery.<category>| AMQP
    Heartbeat -.-> AMQP

    %% Styling
    classDef core fill:#0ea5e9,stroke:#0284c7,stroke-width:2px,color:#fff
    classDef transport fill:#10b981,stroke:#059669,stroke-width:2px,color:#fff
    classDef registry fill:#a78bfa,stroke:#7c3aed,stroke-width:2px,color:#fff
    classDef storage fill:#f59e0b,stroke:#d97706,stroke-width:2px,color:#2d3436
    classDef secure fill:#ef4444,stroke:#b91c1c,stroke-width:2px,color:#fff
    classDef ux fill:#94a3b8,stroke:#64748b,stroke-width:2px,color:#fff
    classDef obs fill:#22d3ee,stroke:#0891b2,stroke-width:2px,color:#1f2937

    class MCPServer,TransportMgr core
    class Stdio,HTTP,AMQP,AMQPEx,AMQPRoute,ReqQ,ResQ transport
    class CoreRegistry,HotReload,Validator,TypesAdapter registry
    class SQLite,CMDB,ToolStats storage
    class CredManager,Encryption,AuditTrails,OAuth secure
    class Prompts,Resources ux
    class Health,Heartbeat obs